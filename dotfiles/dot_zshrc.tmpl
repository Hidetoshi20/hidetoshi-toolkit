# Environment Variables & PATH
# ==========================

# General PATH additions
export PATH="/usr/local/bin:/opt/homebrew/bin:$PATH"
export PATH="/opt/homebrew/sbin:$PATH"
export PATH="$HOME/.local/bin:$PATH"

# Context7 MCP API key (loaded from separate file)
if [ -f "$HOME/.config/context7.env" ]; then
  source "$HOME/.config/context7.env"
fi

# NVM (Node Version Manager)
export NVM_DIR="$HOME/.nvm"

# pnpm
export PNPM_HOME="{{ .chezmoi.homeDir }}/Library/pnpm"
case ":$PATH:" in
  *":$PNPM_HOME:"*) ;;
  *) export PATH="$PNPM_HOME:$PATH" ;;
esac

# Homebrew Bottles mirror
export HOMEBREW_BOTTLE_DOMAIN=https://mirrors.aliyun.com/homebrew/homebrew-bottles

# Proxy settings
export http_proxy=http://127.0.0.1:7897
export https_proxy=http://127.0.0.1:7897

# Antigravity
export PATH="{{ .chezmoi.homeDir }}/.antigravity/antigravity/bin:$PATH"

# Tool Initialization
# ===================

# NVM (Node Version Manager)
[ -s "/opt/homebrew/opt/nvm/nvm.sh" ] && \. "/opt/homebrew/opt/nvm/nvm.sh"
[ -s "/opt/homebrew/opt/nvm/etc/bash_completion.d/nvm" ] && \. "/opt/homebrew/opt/nvm/etc/bash_completion.d/nvm"

# iTerm2 Shell Integration
test -e "${HOME}/.iterm2_shell_integration.zsh" && source "${HOME}/.iterm2_shell_integration.zsh"

# zoxide (Smarter cd command)
if command -v zoxide >/dev/null 2>&1; then
  eval "$(zoxide init zsh)"
fi

# fzf (Fuzzy finder)
if command -v rg >/dev/null 2>&1; then
  [ -z "${FZF_DEFAULT_COMMAND:-}" ] && export FZF_DEFAULT_COMMAND='rg --files --no-messages'
  export FZF_CTRL_T_COMMAND="${FZF_CTRL_T_COMMAND:-$FZF_DEFAULT_COMMAND}"
fi

[ -z "${FZF_CTRL_T_OPTS:-}" ] && export FZF_CTRL_T_OPTS="--preview '([[ -f {} ]] && (sed -n \"1,200p\" {})) 2>/dev/null' --preview-window 'right,60%,border-left'"
[ -z "${FZF_ALT_C_OPTS:-}" ] && export FZF_ALT_C_OPTS="--preview 'ls -la -- {} | sed -n \"1,200p\"' --preview-window 'right,60%,border-left'"

# Interactive ripgrep -> fzf (search in file contents)
rgi() {
  local initial_query="${1:-}"
  local rg_prefix='rg --column --line-number --no-heading --color=always --no-messages'
  local editor="${VISUAL:-${EDITOR:-vim}}"

  fzf --ansi --disabled --query "$initial_query" \
    --bind "change:reload:$rg_prefix {q} || true" \
    --delimiter : \
    --preview 'sh -c '"'"'nl -ba -- "$1" | sed -n "$(( $2-3 < 1 ? 1 : $2-3 )), $(( $2+3 ))p"'"'"' sh {1} {2}' \
    --preview-window 'up,60%,border-bottom,+{2}+3/3,~3' \
    --bind "enter:become($editor +{2} {1})"
}
[ -f ~/.fzf.zsh ] && source ~/.fzf.zsh

# Aliases
# =======

# bun completions
[ -s "{{ .chezmoi.homeDir }}/.bun/_bun" ] && source "{{ .chezmoi.homeDir }}/.bun/_bun"

# bun
export BUN_INSTALL="$HOME/.bun"
export PATH="$BUN_INSTALL/bin:$PATH"
