# Prompt · 行为不变重构

> 适用：拆分超大组件、提取 hook/util、整理状态层；目标是“接口与行为不变”。

## 0. 任务定义 / 背景收集
```text
请把以下重构目标整理成 refactor spec：
- 背景与动机：<描述>
- 现存痛点：<列出>
- 期望产物/新抽象：<描述>
- 明确要求保持不变的行为：<列表>
- 可顺手清理的内容：<列表>
- 范围外：<列表>
- 设计文档：<链接/章节；若需新建或大改请说明>
输出：
1. Summary + Why now
2. “行为必须不变” checklist
3. “可以顺手处理”清单
4. 非目标/范围外
5. 风险 & 需要监控的指标
6. 设计文档同步计划（章节名称、需要更新的内容、若无需更新请附理由）
若信息缺失，请补充澄清问题。
```

## 1. 任务分解 / 施工计划
```text
按照“提取 → 替换 → 清理”的顺序拆步骤，保证每一步结束后应用仍可运行。
每个 step 包含：
- 目的
- 涉及文件
- 新旧抽象之间的关系（老组件继续调用新 hook?）
- 验收方式（哪些行为要比对一致）
需要设计文档更新时，也将其视为单独 step，写清楚章节锚点与要补充的决策。
```

## 2. 上下文装载
```text
以下为当前实现（节选）：
<粘贴大组件/模块代码>
请分析：
1. 哪些逻辑块可以安全抽成 hook/util？输入输出是什么？
2. 哪些 UI 块可以拆成子组件？props 结构如何？
3. 哪些副作用（订阅/事件/定时器）需要保持原触发时机？
输出 patch plan：列出每一步的改动、受影响文件、潜在风险。
```

## 3. 生成 patch（逐步）
```text
针对 Step <编号>：
- 说明目标
- 给出 diff（unified diff）
- 解释行为为何保持不变（引用测试/调用路径）
要求：先抽象/搬运，再切换引用，最后清理；不要提前删除旧逻辑。
```

## 4. 自测 / 回归
```text
请生成“行为不变回归清单”：
- 关键交互路径（逐步）
- 边界输入/异常（空数据、快速点击、性能）
- 观察点：渲染次数、依赖数组、订阅数量
输出格式：checklist + 需要对照的旧行为描述。
```

## 5. Commit / PR
```text
需要：
1. commit 建议（refactor/chore/test）
2. PR title + summary（强调“no behavior change”）
3. Test Plan（引用回归清单）
4. Risk & mitigation（如何监控、如何快速回滚）
5. Design doc Sync（已更新 design.md#章节 or 无需更新 + 理由）
```
